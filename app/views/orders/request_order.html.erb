<div class="container text-white">
  <h3 class="text-left mb-5">결제요청</h3>
  <div class="row">
    <div class="col-12 text-left">
      <div class="form-group">
        <label for="paymentMethod" class="mt-3">결제 방법</label>
        <input type="text" class="form-control" id="paymentMethod" value="<%= @order.payment_method %>" readonly>
      </div>
      <div class="form-group">
        <label for="price">결제 금액</label>
        <input type="text" class="form-control" id="price" value="<%= @order.total %>" readonly>
      </div>
      <div class="form-group">
        <label for="inputFirstName">상품 이름</label>
        <input type="text" class="form-control" id="item_name" value="<%= @order.line_items.map { |line_item| line_item.item.title }.flatten.join(" ") %>" readonly>
      </div>
      <div class="form-group">
        <label for="order_name">주문자</label>
        <input type="text" class="form-control" id="order_name" value="<%= @order.order_name %>" readonly>
      </div>
      <!-- <div class="form-group">
        <label for="order_email">주문자 이메일</label>
        <input type="text" class="form-control" id="order_email" value="<%#= @order.order_email %>" readonly>
      </div> -->
      <div class="form-group">
        <label for="order_phone">주문자 휴대폰 번호</label>
        <input type="text" class="form-control" id="order_phone" value="<%= @order.order_phone %>" readonly>
      </div>
    </div>
  </div>
  <button class="btn btn-lg mt-5 text-white" style="background-color: #757CFF; width: 240px;" id="request_pay">다음</button>
</div>

<script>
  $('#request_pay').click(function () {
    var IMP = window.IMP; // 생략가능
    IMP.init('imp15646341'); // 'iamport' 대신 부여받은 "가맹점 식별코드"를 사용
    IMP.request_pay({
        pg : 'inicis', // version 1.1.0부터 지원.
        pay_method : 'card',
        merchant_uid : 'merchant_' + new Date().getTime(),
        name : 'MoreBox',
        amount : <%= @order.total %>,
        // buyer_email : 'iamport@siot.do',
        buyer_name : '<%= @order.order_name %>',
        buyer_tel : '<%= @order.order_phone %>',
        buyer_addr : '<%= @order.address1 %>',
        buyer_postcode : '<%= @order.zipcode %>'
        // m_redirect_url : 'http://localhost:3000/orders/complete'
    }, function(rsp) {
        if ( rsp.success ) {
          jQuery.ajax({
            url: "http://localhost:3000/orders/index", // 가맹점 서버
            method: "GET",
            headers: { "Content-Type": "application/json" },
            data: {
              imp_uid: rsp.imp_uid,
              merchant_uid: rsp.merchant_uid
            }
          }).done(function (data) {
          // 가맹점 서버 결제 API 성공시 로직

     //[2] 서버에서 REST API로 결제정보확인 및 서비스루틴이 정상적인 경우
          if ( everythings_fine ) {
            var msg = '결제가 완료되었습니다.';
            msg += '고유ID : ' + rsp.imp_uid;
            msg += '상점 거래ID : ' + rsp.merchant_uid;
            msg += '결제 금액 : ' + rsp.paid_amount;
            msg += '카드 승인번호 : ' + rsp.apply_num;
        } else {
            var msg = '결제에 실패하였습니다.';
            msg += '에러내용 : ' + rsp.error_msg;
        }
        alert(msg);
    });
   }
  })
 })
</script>
