<style>
  #drink-count {
    margin-top: 0;
    bottom: 0;
  }
  .fas {
    color: #48689a;
  }
  .btn-lg {
    margin-top: 26px;
  }
  #item-image {
    width: 50%;
  }
  #item-count {
    font-size: 25px;
  }
  .fa-minus-square {
    font-size: 2.6rem;
  }
  .fa-plus-square {
    font-size: 2.6rem;
  }
  #point-button {
    width: 140px;
  }

  @media (min-width: 320px) and (max-width: 480px) {
    #item-image {
      width: 100%;
    }
    #item-count {
      font-size: 20px;
    }
    #drink-count {
      padding-top: 30px;
      bottom: 0;
      margin-left: 20px;
      font-size: 20px;
    }
    .fa-minus-square {
      margin-top: 5px;
      font-size: 1.3rem;
    }
    .fa-plus-square {
      margin-top: 5px;
      font-size: 1.3rem;
    }
    #point-button {
      width: 75px;
    }
    #card-footer {
      position: absolute;
      top: 130%;
      /* margin-top: 80%; */
    }
  }
</style>

<div class="container">
  <% if params[:pg_token].present? %>
    <div class="alert alert-shape alert-color mt-4">
      <span class="badge badge-dark badge-pill">
        알림
      </span>
      <span class="alert-content text-white">충전이 완료되었습니다:)</span>
    </div>
  <% end %>
  <%#= render 'shared/mypage', order: @order %>
  <div class="row">
    <div class="col-3"></div>
    <div class="col-6">
      <h3 class="text-white mb-4" id="drink-count">잔여 포인트: <%= number_with_delimiter(current_user.orders.sum(:point) - current_user.line_items.sum(:point)) %> P</h3>
    </div>
    <div class="col-3 mt-3 text-right">
      <%= link_to "충전", items_path, class: "btn btn-danger", id: "point-button" %>
    </div>
  </div>
  <div class="row">
    <% if current_user.orders.count == 1 %>
      <div class="col-12 text-white">최초 1번은 무료이니 자유롭게 선택해서 드세요:)</div>
    <% end %>
  </div>
  <div class="row mt-4 mb-2">
    <% @order&.line_items&.order(:created_at)&.each do |line_item| %>
      <div class="col-3">
        <img src="<%= SubItem.find_by(title: line_item.title)&.image_url %>" id="item-image" data-target="#exampleModal_<%= line_item.id %>" data-toggle="modal">
        <p class="text-white mt-3"><%= SubItem.find_by(title: line_item.title)&.point %> point</p>
      </div>
      <div class="modal fade" id="exampleModal_<%= line_item.id %>" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel"><%= line_item.title %></h5>
            </div>
            <div class="modal-body row">
              <div class="col-5">
                <img src="<%= SubItem.find_by(title: line_item.title)&.image_url %>" style="width: 100%;">
              </div>
              <div class="col-7 row mt-5 pt-5">
                <div class="col-5">
                  <%= link_to reduce_line_item_path(line_item), remote: true do %>
                    <i class="fa fa-minus mt-2" aria-hidden="true"></i>
                  <% end %>
                </div>
                <div class="col-2">
                  <p id="item-count"><%= line_item.temp %></p>
                </div>
                <div class="col-5">
                  <%= link_to line_item_path(line_item), method: :patch, remote: true do %>
                  <%# , onclick: "sound()" %>
                    <i class="fa fa-plus mt-2" aria-hidden="true"></i>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <%= link_to "닫기", "", class: "btn btn-primary" %>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<div class="container cart text-left" style="background-color: #0f4c83">
  <h4 class="mt-3" style="color: #ff7f00">주문할 상품</h4>
  <div class="content text-white mt-2">
    <% current_user.line_items.where.not(temp: 0).each do |line_item| %>
      <div class="row">
        <p class="ml-3"><%= line_item.title %> <%= line_item.temp %>개</p>
        <%= link_to line_item_path(line_item), method: :delete do %>
          <i class="fa fa-trash-o mt-1 ml-3" aria-hidden="true" style="color: red;"></i>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<div class="container" id="card-footer">
  <%= link_to "로그아웃", destroy_user_session_path, method: :delete, class: "btn btn-lg text-white card_mobile mb-4", style: "background-color: #48689a", data: {confirm: "로그아웃하시겠습니까?"} %>
  <a onclick="AutoLogout(<%= @order&.line_items&.where.not(temp: 0).order(:created_at)&.pluck(:title, :temp)&.map { |result| " "+result.flatten.join(' ') } %>)" id="bb-box" class="btn btn-lg text-white card_mobile ml-5 mb-4" style="background-color: #48689a">
    꺼내 먹기
  </a>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script>
  $(document).ready(function (){
    $('#myModal').modal('show')
  });

  function sound() {
    var sound = document.createElement("audio");
    sound.src = "/gorillabomb.m4a";
    sound.play();
  }

  var timoutNow = 2000;
  var timeoutTimer;

  function AutoLogout(condition) {
    swal({
        title: condition+"개가 맞습니까?",
        type: "success",
        showCancelButton: true,
        confirmButtonText: '예',
        cancelButtonText: "아니오",
        closeOnConfirm: false,
        closeOnCancel: false
    },
    function (isConfirm) {
        if (isConfirm) {
          <% sum = 0 %>
          <% @order.line_items.where.not(temp: 0).map { |result| sum += (result.temp * SubItem.find_by(title: result.title)&.point) }.join.to_i %>
          if(<%= sum <= current_user.orders.sum(:point) - current_user.line_items.sum(:point) %>) {
            <%# byebug %>
            $.ajax({
              // order update
              url : "<%= order_path(@order) %>",
              type : "patch",
              contentType: "application/javascript",
              dataType: "script",
              beforeSend: function ( xhr ) {
                xhr.setRequestHeader( 'X-CSRF-Token', $( 'meta[name="csrf-token"]' ).attr( 'content' ));
              }
            });
            StartTimers();
          }
          else {
            swal("포인트를 초과하셨습니다.", "다시 선택하시거나 결제해주세요!", "error");
          }
        }
        else {
          swal("취소하셨습니다.", "다시 선택해주세요!", "error");
        }
      })
    };

  function StartTimers() {
    swal({
      title: "이제 냉장고에서 꺼내 드세요!",
      button: false,
      text: "2초 후 자동로그아웃 됩니다."
    });
    timeoutTimer = setTimeout("IdleTimeout()", timoutNow);
  }

  function IdleTimeout() {
    window.location = 'https://morebox.co.kr/items/auto_out'
    // window.location = 'http://localhost:3000/items/auto_out'
  }
</script>
