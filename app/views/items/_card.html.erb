<style>
  #drink-count {
    margin-top: 0;
    bottom: 0;
  }
  .fas {
    color: #48689a;
  }
  .btn-lg {
    margin-top: 26px;
  }
  #item-image {
    width: 53%;
  }
  #item-count {
    font-size: 25px;
  }
  .fa-minus-square {
    font-size: 2.6rem;
  }
  .fa-plus-square {
    font-size: 2.6rem;
  }

  @media (min-width: 320px) and (max-width: 480px) {
    #item-image {
      width: 100%;
    }
    #item-count {
      font-size: 20px;
    }
    #drink-count {
      padding-top: 30px;
      bottom: 0;
      margin-left: 20px;
      font-size: 20px;
    }
    .fa-minus-square {
      margin-top: 5px;
      font-size: 1.3rem;
    }
    .fa-plus-square {
      margin-top: 5px;
      font-size: 1.3rem;
    }
  }
</style>

<div class="container">
  <% if params[:pg_token].present? %>
    <div class="alert alert-shape alert-color mt-4">
      <span class="badge badge-dark badge-pill">
        알림
      </span>
      <span class="alert-content text-white">결제가 완료되었습니다:)</span>
    </div>
  <% end %>
  <% count = 0 %>
  <%#= render 'shared/mypage', order: @order %>
  <h3 class="text-white mb-4" id="drink-count">누적 사용 <%= (@order&.number % @order&.item&.count) %> / <%= @order&.item&.count %>개</h3>
  <div class="row">
    <div class="col-4"></div>
    <div class="col-4 text-white">최초 1회는 무료이니 그냥 드시면 됩니다:)</div>
    <div class="col-4"><small class="text-white">모든 제품이 동일하게 1개 차감됩니다.</small></div>
  </div>
  <div class="row mt-4">
    <% @gym&.sub_items&.order(:created_at)&.each do |sub_item| %>
      <%# byebug %>
      <div class="col-4">
        <img src="<%= sub_item.image_url %>" id="item-image">
        <div class="row mt-4">
          <!-- line_item update -->
          <div class="col-4">
            <%= link_to reduce_line_item_path(LineItem.find_by(title: sub_item.title, order: @order)), remote: true do %>
              <i class="fas fa-minus-square"></i>
            <% end %>
          </div>
          <div class="col-4">
            <p class="text-white" id="item-count"><%= LineItem.find_by(title: sub_item.title, order: @order).temp %></p>
          </div>
          <div class="col-4">
            <%= link_to line_item_path(LineItem.find_by(title: sub_item.title, order: @order)), method: :patch, remote: true do %>
            <%# , onclick: "sound()" %>
              <i class="fas fa-plus-square"></i>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
    <% if false %>
      <% @order&.line_items&.order(:created_at)&.each do |line_item| %>
        <div class="col-4">
          <img src="/<%= count %>.png" id="item-image">
          <div class="row mt-4">
            <!-- line_item update -->
            <div class="col-4">
              <%= link_to reduce_line_item_path(line_item), remote: true do %>
                <i class="fas fa-minus-square"></i>
              <% end %>
            </div>
            <div class="col-4">
              <p class="text-white" id="item-count"><%= line_item.temp %></p>
            </div>
            <div class="col-4">
              <%= link_to line_item_path(line_item), method: :patch, remote: true do %>
              <%# , onclick: "sound()" %>
                <i class="fas fa-plus-square"></i>
              <% end %>
            </div>
          </div>
        </div>
        <% count += 1 %>
      <% end %>
    <% end %>
  </div>
  <%= link_to "로그아웃", destroy_user_session_path, method: :delete, class: "btn btn-lg text-white card_mobile mb-4", style: "background-color: #48689a", data: {confirm: "로그아웃하시겠습니까?"} %>
  <a onclick="AutoLogout(<%= @order&.line_items&.order(:created_at)&.pluck(:title, :temp)&.map { |result| result.flatten.join(' ') } %>)" id="bb-box" class="btn btn-lg text-white card_mobile ml-5 mb-4" style="background-color: #48689a">
    꺼내 먹기
  </a>

  <% if false %>
    <% if current_user.item.id == Item.first.id %>
      <div class="modal" tabindex="-1" role="dialog" id="myModal">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title ml-5">@@@@@경축@@@@@아잇 좋아^^</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p>회원가입을 축하합니다. <br>최초 1개를 무료로 제공해 드리니, <br> 원하시는 제품을 선택 후 '꺼내 먹기' 클릭해주세요.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script>
  $(document).ready(function (){
    $('#myModal').modal('show')
  });

  function sound() {
    var sound = document.createElement("audio");
    sound.src = "/gorillabomb.m4a";
    sound.play();
  }

  var timoutNow = 2000;
  var timeoutTimer;

  function AutoLogout(condition) {
    swal({
        title: condition+"개가 맞습니까?",
        type: "success",
        showCancelButton: true,
        confirmButtonText: '예',
        cancelButtonText: "아니오",
        closeOnConfirm: false,
        closeOnCancel: false
    },
    function (isConfirm) {
        if (isConfirm) {
          if(<%= @order.line_items.sum(:temp) <= @order.item.count %>) {
            $.ajax({
              // order update
              url : "<%= order_path(@order) %>",
              type : "patch",
              contentType: "application/javascript",
              dataType: "script",
              beforeSend: function ( xhr ) {
                xhr.setRequestHeader( 'X-CSRF-Token', $( 'meta[name="csrf-token"]' ).attr( 'content' ));
              }
            });
            swal({
                title: "구매가 완료되었습니다.",
                text: "버튼을 누르시면 자동 로그아웃 됩니다.",
                type: "success",
                confirmButtonText: '예',
                closeOnConfirm: false
            },
            function (isConfirm) {
                if (isConfirm) {
                  StartTimers()
                  IdleTimeout()
                }
                else {

                }
            });
          }
          else {
            swal("사용권 횟수를 초과하셨습니다.", "다시 선택해주세요!", "error");
          }
        }
        else {
          swal("취소하셨습니다.", "다시 선택해주세요!", "error");
        }
      })
    };

  function StartTimers() {
    timeoutTimer = setTimeout("IdleTimeout()", timoutNow);
  }

  function IdleTimeout() {
    swal({
        title: "이제 냉장고에서 꺼내 드세요!",
        type: "success",
        confirmButtonText: '예',
        closeOnConfirm: false
    },
    function (isConfirm) {
        if (isConfirm) {
          // window.location = 'http://localhost:3000/items/auto_out'
          window.location = 'http://morebox.co.kr/items/auto_out'
        }
        else {

        }
    });
  }
</script>
