<%= render 'card_css' %>
<div class="container" style="overflow: auto">
  <% if params[:alert].present? %>
    <div class="alert alert-shape alert-color mt-4">
      <span class="badge badge-dark badge-pill">
        알림
      </span>
      <span class="alert-content text-white">충전이 완료되었습니다:)</span>
    </div>
  <% end %>
  <%#= render 'shared/mypage', order: @order %>
  <div class="row justify-content-center">
    <div class="col-6">
      <h3 class="text-white mb-4" id="drink-count">잔여 포인트: <%= number_with_delimiter(current_user.remained_point) %> P</h3>
      <%= link_to list_items_path do %>
        <%= image_tag '/refresh.png' %>
      <% end %>
    </div>
  </div>
  <div class="row mt-3"></div>
  
  <% if (current_user.orders.count == 0) %>
    <%= render 'welcome_modal' %>
  <% end %>

  <% categories = Category.all.order(:created_at) %>
  <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
    <% categories.each_with_index do |category, index| %>
      <li class="nav-item">
        <a class="nav-link <%= 'active' if index.to_i.zero? %>" style="color: #efb758;" id="<%= category.id %>" data-toggle="tab" href="#<%= category.title %>" role="tab" aria-selected="false"><%= category.description %></a>
      </li>
    <% end %>
  </ul>
  <div class="tab-content" id="myTabContent">
    <% categories.each_with_index do |category, index| %>
      <%= render "category_tab", category: category, index: index %>
    <% end %>

  </div>
</div>

<div class="container cart text-left" style="background-color: #0f4c83;">
  <h4 class="mt-3" style="color: #efb758;">주문할 상품</h4>
  <div class="content text-white mt-2 cart-list">
  </div>
</div>

<%= form_with url: points_path, id: "cart", class: "w-100", method: :post do %>
  <%# current_user.gym&.sub_items.each do |sub_item| %>
  <% current_gym&.sub_items.each do |sub_item| %>
    <%= hidden_field_tag "sub_item_#{sub_item.id}", 0, name: "sub_item[#{sub_item.id}]", class: "sub_item_field", data: {title: sub_item.title, id: sub_item.id} %>
  <% end %>
  <div class="row justify-content-center">
    <%= link_to "로그아웃", destroy_user_session_path, method: :delete, class: "btn btn-lg text-white card_mobile mb-4", style: "background-color: #48689a", data: {confirm: "로그아웃하시겠습니까?"} %>
    <%# submit_tag "꺼내 먹기", class: "btn btn-lg text-white card_mobile ml-5 mb-4", style: "background-color: #48689a", onclick: "sound()" %>
    <%= link_to "포인트 충전", items_path, class: "btn btn-lg ml-5 mb-4", id: "point-button", style: "background-color: #48689a; color: white;" %>
    <%= submit_tag "구매하기", class: "btn btn-lg text-white card_mobile ml-5 mb-4 px-5 submit_btn", style: "background-color: #efb758; color: #48689a;", onclick: "sound()" %>
     <audio id="audio" src="/click.mp3"></audio>
  </div>
<% end %>

  <%= render 'payment_modal' %>


<script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
<script>
  $(document).ready(function() {
    $("#modal-trigger").click();
  })

  function sound() {
    var audio = document.getElementById("audio");
    audio.play();
  }

  $(".plus-btn, .minus-btn").click(function(e){
    e.preventDefault();
    let limitQty = parseInt($(this).data("limit"));
    let subitemId = $(this).data("target");
    let targetQtyEl = $("#item-count-" + subitemId);
    let targetQty = parseInt(targetQtyEl.text());
    let val = ($(this).hasClass("plus-btn") ? 1 : -1);
    targetQty = targetQty + val
    if (targetQty > limitQty){
      alert("해당 상품의 재고가 부족합니다.")
    }else{
      if(targetQty >= 0){
        targetQtyEl.text(targetQty);
      }
    }
    return false;
  });

  $(".select-btn").click(function(){
    let targetId = $(this).data("target");
    $("#sub_item_" + targetId).val($("#item-count-" + targetId).text());
    $(".sub_item_field").change();
  });
  
  function deleteItem(subitemId){
    $("#sub_item_"+subitemId).val(0);
    $(".sub_item_field").change();
  }

  $(".sub_item_field").change(function(){
    var html = ""
    $(".sub_item_field").each(function(){
      let target = $(this)
      if(parseInt(target.val()) > 0){
        html = html +
        '<div class="row">' +
          '<p class="ml-3"> ' + target.data("title") + ' ' + target.val() + '개</p>' +
          '<a href="#" onclick="deleteItem(' + target.data("id") + ');return false;">' +
            '<i class="far fa-trash-alt mt-1 ml-3" aria-hidden="true" style="color: red;"></i>' +
          '</a>' +
        '</div>'
      }
    });
    $(".cart-list").html(html);
  });


</script>
