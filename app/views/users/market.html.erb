<style>
  body {
    background: white !important;
  }
  .main-text-color {
    color: #200e57;
  }
  .secondary-text-color {
    color: #8a8a8a;
  }
  .line-height-25 {
    line-height: 25px;
  }
  .bg-custom-grey {
    background: #cfd3df;
  }
  .btn-custom-lightgrey {
    font-size:12px;
    background: #e9edf1;
  }
  .btn-custom-grey {
    border: 1px solid #202649;
    background: #cfd3df !important;
  }
  .btn {
    border-radius: 0px;
  }
  .progress {
    position:relative;
    margin: 10px 0;
    height: 1.3rem;
  }
  label {
    color: #200e57;
    font-size: 13px;
    white-space: pre;
    line-height:30px;
  }
  input, select {
    font-size: 13px;
    color: #8a8a8a !important;
    border-radius: 0px !important;
  }
  .user-info p.info{
    color: #8a8a8a;
    font-size: 12px;
    space: nowrap;
  }
  .user-info p.info.small{
    font-size: 9px;
  }
  .calorie-amount {
    position:absolute;
    left:0;
    right:0;
    font-weight:bold;
    line-height:200%;
  }
  #change-color, .change-color {
    background-color: #e9eef2;
  }
  #tool-bar {
    width: 100%;
    height: 280px;
    position: fixed;
    bottom: 0%;
    /* background-color:#19244f !important; */
    background-color: transparent;
  }
  input:checked + label {
    color: red;
  }
  .visually-hidden {
    position: absolute;
    left: -100vw;
  }
  .user-info{
    background-color: #e9edf1;
  }
  .btn-morebox {
    background-color: #200e57;
    color: white;
  }
  .btn:hover {
    color: white;
  }
  #output {
    color: #200e57;
    background: white;
    height: 55%;
  }
  #output #calorie-info{
    /* font-size:12px; */
  }
  #output .calorie-title {
    font-weight:bold;
    font-size:12px;
  }
  .hat-outer{
    height: 70px;
    background: #e9edf1;
  }
  .hat-outer .row{
    height: 100%;
  }
  .hat{
    height: 100%;
    background: white;
  }
  .hat.right {
    padding: 0px;
    border-radius: 0 50% 0 0;
  }
  .hat.left {
    padding: 0px;
    border-radius: 50% 0 0 0;
  }
  .container.wear-hat {
    padding-top: 30px;
  }
  .btn:hover {
    color: unset;
  }
  input:checked + label {
    color: white !important;
    background: #200e57 !important;
  }
  .card-title {
    font-size: 12px;
  }

  #tool-bar .hat-outer { background: transparent;}
  #tool-bar .hat { background:#200e57; border: 1px #200e57 solid;}
  #tool-bar .inner { 
    background:#200e57;
    margin-top: -35px;
    position: relative;
    height: 100%;
  } 

  .progress-bar-vertical {
    width: 100%;
    min-height: 100px;
    margin-right: 20px;
    float: left;
    display: -webkit-box;  /* OLD - iOS 6-, Safari 3.1-6, BB7 */
    display: -ms-flexbox;  /* TWEENER - IE 10 */
    display: -webkit-flex; /* NEW - Safari 6.1+. iOS 7.1+, BB10 */
    display: flex;         /* NEW, Spec - Firefox, Chrome, Opera */
    align-items: flex-end;
    -webkit-align-items: flex-end; /* Safari 7.0+ */
  }

  .progress-bar-vertical .progress-bar {
    width: 100%;
    height: 0;
    -webkit-transition: height 0.6s ease;
    -o-transition: height 0.6s ease;
    transition: height 0.6s ease;
  }
</style>


<div class="user-info pt-4 px-4">
  <h4 class="bg-custom-grey main-text-color py-2 line-height-25">칼로리 계산기</h4>
  <p class="info text-left mb-2">간단하게 사용자 정보를 입력해주세요.</p>
  <div class="row">
    <div class="col-6">
      <div class="row">
      <%= label_tag  "age", "나이(만/세)", style: "", class: "col-5 pr-1 text-left" %>
      <%= number_field_tag "age", (params[:age] or 24), class: "form-control mb-3 col-7" %>
      </div>
      <div class="row">
        <%= label_tag  "height", "키(cm)", style: "", class: "col-5 pr-1 text-left" %>
        <%= number_field_tag "height", (params[:height] or 170), class: "form-control mb-3 col-7" %>
      </div>
      <div class="row">
        <%= label_tag  "weight", "몸무게(kg)", class: "col-5 pr-1 text-left" %>
        <%= number_field_tag "weight", (params[:weight] or 70), class: "form-control mb-3 col-7" %>
      </div>

      <div class="row">
        <%= label_tag  "gender", "성별", style: "", class: "col-5 pr-1 text-left"  %>
        <%= select_tag "gender", options_for_select(%w(남 여)), class: "form-control mb-3 col-7 px-1" %>
      </div>
      <div class="row">
        <%= label_tag  "activity", "활동강도", class: "col-5 pr-1 text-left" %>
        <%= select_tag "activity", options_for_select(["전혀없음(사무직)", "조금(5천보)", "보통(만보)", "많이(2만보)", "엄청(3만보)"]), class: "form-control mb-3 col-7 px-1" %>
      </div>
    </div>
    <div class="col-6 px-2">
      <div class="row justify-content-center mb-2">
        <%= link_to "계산하기", "#", class: "btn btn-morebox px-4", onclick: "calculateCalorie($('#age').val(), $('#height').val(), $('#weight').val(), $('#gender').val(), $('#activity').val()); false;" %>
      </div>
      <div class="row justify-content-center mb-4">
        <%= link_to "뒤로가기", users_path, class: "btn btn-custom-grey px-4" %>
      </div>
      <div id="output" class="mt-4 border">
        <div class="py-2 px-3">
        <div class="calorie-title"> 총 대사량 </div>
          <span id="top-calorie">0000</span> &nbsp; <span class="secondary-text-color">Kcal</span> 
        </div>
        <hr class="my-0">
        <div class="py-2 px-4 row">
          <div class="col-4">
            <div class="row justify-content-center">
              <div class="px-1 calorie-title col-12">탄수화물</div>
              <small class="secondary-text-color" style="font-size:10px;line-height:10px;">(권장)</small>
              <br>
              <div class="col-12 px-1" style="line-height:15px;">
                <span id="top-carbo">000</span><span class="secondary-text-color">g</span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="row justify-content-center">
              <div class="px-1 calorie-title col-12">지방</div>
              <small class="secondary-text-color" style="font-size:10px;line-height:10px;">(권장)</small>
              <br>
              <div class="col-12 px-1" style="line-height:15px;">
                <span id="top-protein">000</span><span class="secondary-text-color">g</span>
              </div>
            </div>
          </div>
          <div class="col-4">
            <div class="row justify-content-center">
              <div class="px-1 calorie-title col-12">단백질</div>
              <small class="secondary-text-color" style="font-size:10px;line-height:10px;">(권장)</small>
              <br>
              <div class="col-12 px-1" style="line-height:15px;">
                <span id="top-fat">000</span><span class="secondary-text-color">g</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <p class="info text-left small">* 본 칼로리 계산값은 000000000를 토대로 제작되었습니다.<br>유연하게 적용하셔도 무방합니다.</p>
</div>
<div class="hat-outer pt-4">
  <div class="row mx-0">
    <div class="hat left col-2"></div>
    <div class="hat col-8 pt-4">
      <h4 class="mt-2 main-text-color">모어마켓 제품 담기</h4>
    </div>
    <div class="hat right col-2"></div>
  </div>
</div>
<div class="container wear-hat" style="padding-bottom: 250px;">
  <div class="row">
    <% SubItem.order(:created_at).each do |sub_item| %>
      <% if sub_item.calorie.present? %>
        <div class="col-4">
          <h5 class="card-title main-text-color mb-1"><%= sub_item.title %></h5>
          <%= link_to "#", onclick: "$(this).next().find('#toggle_#{sub_item.id}').click();return false;" do %>
            <img class="card-img-top" src="<%= sub_item.image %>"/>
          <% end %>
          <div class="card-body px-0">
            <!--<p class="card-text"><%# sub_item.description %></p>-->
            <input type="checkbox" id="toggle_<%= sub_item.id %>" class="visually-hidden" data-calorie="<%= sub_item.calorie %>" data-carbo="<%= sub_item.carbo %>" data-protein="<%= sub_item.protein %>" data-fat="<%= sub_item.fat %>" data-title="<%= sub_item.title %>">
            <label for="toggle_<%= sub_item.id %>" class="btn btn-block w-100 btn-custom-lightgrey py-1" id="calorie-check">담기</label>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<div id="tool-bar">
  <div class="hat-outer">
    <div class="row mx-0">
      <div class="hat left col-2"></div>
      <div class="hat col-8"></div>
      <div class="hat right col-2"></div>
    </div>
  </div>
  <div class="inner">
    <div class="row justify-content-between mb-4">
      <h4 class="my-0 ml-5 text-white" style="line-height:25px;">칼로리 장바구니</h4>
      <div class="mr-5">
        <button id="reset" class="btn btn-sm text-white change-color" style="color:#200e57 !important">리셋</button>
        <button id="share" class="btn btn-sm text-white change-color mr-2" style="color:#200e57 !important" onclick="sendMessage();return false;">공유하기</button>
      </div>
      
    </div>
    <div class="container">
      <div class="row">
        <div class="col-4">
        <h5 class="text-white mb-0">총 칼로리</h5>
          <div class="progress progress-bar-vertical" style="height:100%;">
            <div class="progress-bar" id="calorie-bar" role="progressbar" style="width:100%;height:2%;background:#5cffe2;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            <span class="calorie-amount"><span id="calorie-amount">0 Kcal</span></span>
          </div>
        </div>
        <div class="col-8">
          <% [["carbo", "success", "탄수화물"], ["protein", "info", "단백질"], ["fat", "warning", "지방"]].each do |element, color, element_kr| %>
            <div class="progress">
              <div class="progress-bar bg-<%= color %>" id="<%= element %>-bar" role="progressbar" style="width:2%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
              <span class="calorie-amount"><%= element_kr %> <span id="<%= element %>-amount"></span></span>
            </div>
        <% end %>
        </div>
      </div>
      
      <div class="calorie-content">
      </div>
      
    </div>
  
  </div>
</div>

<script>
  var total_calorie = total_carbo = total_protein = total_fat = 0;
  var total_calorie_rate = ideal_carbo = ideal_protein = ideal_fat = 0;

  function caloriePlus(calorie, carbo, protein, fat) {
    total_calorie += calorie;
    total_carbo += carbo;
    total_protein += protein;
    total_fat += fat;
    html_write();
  };

  function calorieMinus(calorie, carbo, protein, fat) {
    total_calorie -= calorie;
    total_carbo -= carbo;
    total_protein -= protein;
    total_fat -= fat;
    html_write();
  };

  function html_write() {

    var html = ""
    let total_calorie_percentage = parseFloat(((total_calorie / total_calorie_rate) * 100).toFixed(2))
    let total_carbo_percentage = parseFloat(((total_carbo / ideal_carbo) * 100).toFixed(2))
    let total_protein_percentage = parseFloat(((total_protein / ideal_protein) * 100).toFixed(2))
    let total_fat_percentage = parseFloat(((total_fat / ideal_fat) * 100).toFixed(2))

    $("#calorie-amount").text(` : ${isFinite(total_calorie_percentage) ? total_calorie_percentage : '-'} % (${total_calorie} g  /  ${total_calorie_rate} g)`);
    $("#carbo-amount").text(` : ${isFinite(total_carbo_percentage) ? total_carbo_percentage : '-'} % (${total_carbo} g  /  ${ideal_carbo} g)`);
    $("#protein-amount").text(` : ${isFinite(total_protein_percentage) ? total_protein_percentage : '-'} % (${total_protein} g  /  ${ideal_protein} g)`);
    $("#fat-amount").text(` : ${isFinite(total_fat_percentage) ? total_fat_percentage : '-'} % (${total_fat} g  /  ${ideal_fat} g)`);

    $("#calorie-bar").width(`${total_calorie_percentage}%`);
    $("#carbo-bar").width(`${total_carbo_percentage}%`);
    $("#protein-bar").width(`${total_protein_percentage}%`);
    $("#fat-bar").width(`${total_fat_percentage}%`);

    $(".calorie-content").html(html);
  }

  $('input[type="checkbox"]').click(function(){

    calorie = parseFloat(this.dataset.calorie)
    carbo = parseFloat(this.dataset.carbo)
    protein = parseFloat(this.dataset.protein)
    fat = parseFloat(this.dataset.fat)

    if(total_calorie_rate == 0) {
      Swal.fire({
      title: '칼로리 계산을 먼저하세요!',
      showCancelButton: false,
      confirmButtonText: '확인',
      })
      $(this). prop("checked", false);
    } else {
      if($(this).prop("checked")){
        caloriePlus(calorie, carbo, protein, fat)
      } else {
        calorieMinus(calorie, carbo, protein, fat)
      }
    }

  });

  function calculateCalorie(age, height, weight, gender, activity){
    age = parseFloat(age)
    height = parseFloat(height)
    weight = parseFloat(weight)

    if(gender == "남") {
      base_calorie_rate = Math.round(10*weight + 6.25 * height - 5 * age + 5)
    } else {
      base_calorie_rate = Math.round(10 * weight + 6.25 * height - 5 * age - 161)
    }

    if(activity == "전혀없음(사무직)") {
      total_calorie_rate = 1.2 * base_calorie_rate
    } else if(activity == "조금(5천보)") {
      total_calorie_rate = 1.375 * base_calorie_rate
    } else if(activity == "보통(만보)") {
      total_calorie_rate = 1.555 * base_calorie_rate
    } else if(activity == "많이(2만보)") {
      total_calorie_rate = 1.725 * base_calorie_rate
    } else {
      total_calorie_rate = 1.9 * base_calorie_rate
    }

    total_calorie_rate = Math.round(total_calorie_rate)
    ideal_protein = Math.round(weight * 1.5)
    ideal_fat = Math.round(weight * 1.1)
    ideal_carbo = Math.round((total_calorie_rate - (ideal_protein * 4) - (ideal_fat * 9)) / 4)

    // document.getElementById('output').innerHTML = "총대사량: " + total_calorie_rate + "kcal"
    // + "<br>" + "<span id='calorie-info'>탄수화물(권장): " + ideal_carbo + "g, &nbsp" + " 단백질(권장): " + ideal_protein + "g, " + "&nbsp;" + "지방(권장): " + ideal_fat + "g</span>";
    $("#output #top-calorie").text(total_calorie_rate);
    $("#output #top-carbo").text(ideal_carbo);
    $("#output #top-protein").text(ideal_protein);
    $("#output #top-fat").text(ideal_fat);
    html_write();
  }

  $('#reset').click(function() {
    // var html = ""
    // $(".calorie-content").html(html);
    $('input[type="checkbox"]:checked').click();
  });
  function sendMessage(){
    Swal.fire({
    title: '공유하실 휴대폰 번호를<br>입력해주세요 :)',
    input: 'text',
    inputPlaceholder: '숫자만 입력',
    inputAttributes: {
      autocapitalize: 'off'
    },
    showCancelButton: true,
    confirmButtonText: '공유하기',
    cancelButtonText: '취소',
    showLoaderOnConfirm: false,
    preConfirm: (phone_num) => {
      return fetch(`/users/check_and_send_message?phone_num=${phone_num}&checked_items=${$('input[type="checkbox"]:checked').map(function(i, e){return $(e).data("title")}).get().join(", ")}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(response.statusText)
          }
          return response.json()
        })
        .catch(error => {
          Swal.showValidationMessage(
            `요청에 실패하였습니다: ${error}`
          )
        })
    },
    allowOutsideClick: () => !Swal.isLoading()
  }).then((result) => {
    console.log(result)
    if (result.isConfirmed) {
      Swal.fire({
        title: `${result.value.message}`
      })
    }
  })
  }

</script>
