<%= render 'users/market_style' %>
<style>
  .line-height-30 {
    line-height: 30px;
  }
  body {
    background: #cfd3df !important;
  }
  input {
    border: 1px solid #202649 !important;
  }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/datepicker/1.0.9/datepicker.min.js" integrity="sha512-Hkemjwczq2iepz/dVjaZ/Xd+agLwV7Od5nQ+R74m4E8ruIblnDAJOewx2+xT4TQ+Q9Q2bcMHFD/d70RzVjrWVw==" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datepicker/1.0.9/datepicker.min.css" integrity="sha512-Yog+zkte66L91S9y4tcyhCpjvzKjlBxNLW38pm9K2ukBtPN55LKl3dyGvb7ylCFmn/kFKNzN9KbnGPOnHGHxbw==" crossorigin="anonymous" />
<!-- <h2 class="main-text-color">test</h2> -->
<%= form_tag :survey do %>
  <div class="tab-content" id="myTabContent">
  
    <%= render 'survey_tab_pane', index: 0, next_tab: 1 do %>
      <h3 class="mb-5 main-text-color">필요한 칼로리를 구하기 위한 알고리즘</h3>

      <h4 class="main-text-color text-left">신체정보와 목표를 입력해주세요.</h4>
      <div class="row mx-0">
        <div class="col-6 row pb-2 mx-0">
          <%= label_tag "age", "나이  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= text_field_tag "age", "", class: "form-control col-6 text-right", required: true %>
        </div>
        <div class="col-6 row pb-2 mx-0">
          <%= label_tag "weight", "체중  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= number_field_tag "weight", "", class: "form-control col-6 text-right", required: true %>
          <div class="col-2 p-0 line-height-30 main-text-color">kg</div>
        </div>
        <div class="col-12 row pb-2 mx-0">
          <%= label_tag "target_weight", "목표 체중  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= number_field_tag "target_weight", "", class: "form-control col-6 text-right", required: true %>
          <div class="col-2 p-0 line-height-30 main-text-color">kg</div>
        </div>
        <div class="col-12 row pb-2 mx-0">
          <%= label_tag "target_date", "목표 날짜  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= text_field_tag "target_date", "", class: "form-control col-8 text-right", readonly: true, required: true %>
        </div>

      </div>

      <h4 class="main-text-color text-left">당신의 활동량은 어떻게 되시나요?</h4>
      <% options = ["대부분 앉아있는다. ex) 사무직", "걷는걸 좋아하고 돌아다닐일이 많다.", "많이 활동 하는 생활을 한다. ex) 영업직", "매우 매우 활동적이다. ex) 영업직, 서비스직"]%>
      <%= select_tag "activity", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option", required: true %>

      <h4 class="main-text-color text-left">당신은 1회 운동할 때 평균 몇 분을 운동 하시나요?</h4>
      <div class="row mx-0 main-text-color">
        <%= number_field_tag "work_time", "", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">시간</span>
      </div>

      <h4 class="main-text-color text-left">당신은 그 운동을 주 몇 회 이상 하실 계획입니까?</h4>
      <div class="row mx-0 main-text-color">
        <%= number_field_tag "work_count", "", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>
        
    <% end %>

    <%= render 'survey_tab_pane', index: 1, prev_tab: 0, next_tab: 2 do %>
      <h3 class="mb-5 main-text-color">소비자가 먹고있는 칼로리를 구하기 위한 알고리즘 질문</h3>

      <h4 class="main-text-color mt-2 text-left">1.  이번엔 정말로 마음 먹으셨습니까?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= radio_button_tag :dummy1, 'yes', "", class: "mr-2 ", style: "display:none;", checked: true %>
        <%= label_tag "dummy1_yes", '네', class: "main-text-color mr-3 font-weight-bold btn" %>
        <%= radio_button_tag :dummy1, 'no', "", class: "mr-2", style: "display:none;" %>
        <%= label_tag "dummy1_no", '아니오', class: "main-text-color font-weight-bold btn" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">2. 식단관리를 통해 어떤 목표를 이루고 싶나요?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = ["옷을 입었을 때 적당히 티가나는 마르고 탄탄한 몸", "나는 이번에 물놀이를 할거야! 누가봐도 몸짱! ", "많은 근육을 키우고 싶어!", "몸짱보단 더 나은 활력, 기능적인 증가"] %>
        <%= select_tag "dummy2", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">3.  당신의 의지력은 어떻게 되십니까?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = ["내가 마음을 먹었다면 무조건 이루어 내야한다.", "보통 만큼의 의지력을 소유하고 있다.", "난 의지력이 존재하긴 할까?..."] %>
        <%= select_tag "dummy3", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">4. 한국인 평균 한 끼 식사 칼로리는 약 700 kal입니다  (예시 이미지를 동시에 보여주며) - 이런 식사를 당신은 하루에 몇 끼 정도 드시나요? </h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "kcal", "", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>

    <% end %>
    <%= render 'survey_tab_pane', index: 2, prev_tab: 1, next_tab: -1 do %>
      <h4 class="main-text-color mt-2 text-left">5. 당신은 하루에 간식을 몇번 드시나요? (바닐라라떼, 케이크, 빵 예시 이미지)</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "kcal_sub1", "", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>
      
      <h4 class="main-text-color mt-2 text-left">6. 당신은 일주일에 야식, 외식, 또는 술자리를 몇 번 가지시나요? (주관식) - [당신이 먹는 칼로리]에 700kal x n/일주일 [+]</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "kcal_sub2", "", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>

      <h4 class="main-text-color mt-2 text-left">7. 당신은 일주일 동안 한 종류의 음식만 먹는다면 어떤걸 드실건가요?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = ["고기 류", "빵, 밥, 면"] %>
        <%= select_tag "dummy4", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">8. 당신이 지금 떠오르는 제일 먹고 싶은 음식 한 가지를 써주세요 </h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= text_field_tag "dummy5", "", class: "form-control col-12 text-right" %> 
      </div>
    <% end %>

    <%= render 'survey_tab_pane', index: -1, prev_tab: 2 do %>
      <h2 class="mb-5 main-text-color">계산결과</h2>

      <div class="row mx-0 pt-3">
        <div class="col-6">
          <h4 class="main-text-color mb-0">현재 섭취 칼로리</h4>
          <div class="progress progress-bar-vertical">
            <div class="progress-bar" id="current-calorie-bar" role="progressbar" style="height:15%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="calorie-amount justify-item-center justify-content-between" style="flex-direction: column;">
              <div class="text-white">
                <div id="total-calorie-amount"></div>
                <div id="total-calorie-rate" style="line-height:5px;"></div>
              </div>
              <div id="current-calorie-amount">0 Kcal</div>
            </div>
          </div>
        </div>
        <div class="col-6">
          <h4 class="main-text-color mb-0">목표 섭취 칼로리</h4>
          <div class="progress progress-bar-vertical">
            <div class="progress-bar" id="target-calorie-bar" role="progressbar" style="height:15%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            <div class="calorie-amount justify-item-center justify-content-between" style="flex-direction: column;">
              <div class="text-white">
                <div id="total-calorie-amount"></div>
                <div id="total-calorie-rate" style="line-height:5px;"></div>
              </div>
              <div id="target-calorie-amount">0 Kcal</div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <h3 class="main-text-color mt-4 mb-5" id="difference"></h3>
        </div>
      </div>
      
      
    <% end %>


  </div>
<% end %>

<script>
  $(".nav-btn").click(function(){
    $(this).removeClass("active");
  });
  $(function(){
    $("#target_date").datepicker({
      dateFormat: "yy-mm-dd"
    });
  });

  $(".calculate-btn").click(function(){
    let weight = parseFloat($("#weight").val());
    let target_weight = parseFloat($("#target_weight").val());
    let target_date = $("#target_date").val();
    let difference = (target_weight - weight);
    let standard_kcal = (difference < 0) ?  7200 : 9000;
    target_date = new Date(target_date);
    let today = new Date();
    let diffTime = Math.abs(target_date - today);
    let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    let work_time = parseFloat($("#work_time").val());
    let work_count = parseInt($("#work_count").val());
    let kcal_sub1 = (parseInt($("#kcal_sub1").val()) * 200) / 7;
    let kcal_sub2 = (parseInt($("#kcal_sub2").val()) * 700) / 7;
    
    let present_result = 2800 + kcal_sub1 + kcal_sub2
    let target_result = present_result + ((standard_kcal * difference) / diffDays) + ((work_count * work_time * 330) / 7);
    if (isNaN(present_result) || isNaN(target_result)){
      Swal.fire({
        title: "계산실패",
        button: false,
        text: "값을 모두 입력해주세요."
      });
      return false;
    }else {
      $("#current-calorie-amount").text(`${present_result.toFixed(2)} Kcal`);
      $("#target-calorie-amount").text(`${target_result.toFixed(2)} Kcal`);

      $("#current-calorie-bar").height(`${present_result.toFixed(2)/50}%`);
      $("#target-calorie-bar").height(`${target_result.toFixed(2)/50}%`);
      $("#difference").text(`하루에 ${(target_result - present_result).toFixed(2)} Kcal 만큼 ${(difference < 0) ? '덜' : '더'} 드셔야 합니다.`);
    }
  });
</script>