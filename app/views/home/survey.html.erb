<%= render 'users/market_style' %>
<style>
  .line-height-30 {
    line-height: 30px;
  }
  body {
    background: #e9edf1 !important;
  }
  input {
    border: 1px solid #202649 !important;
  }
</style>
<div class="text-left px-4 py-3 bg-white">
  <%= image_tag "/list_logo.png", class: "w-50" %>
</div>
<div class="progress mt-0 mb-3" style="height:10px;">
  <div class="progress-bar" id="top-progress-bar" role="progressbar" style="width:25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<%= form_tag recommend_diets_path, id: :recommend, method: :get, remote: true do %>
  <div class="tab-content" id="myTabContent">
    <%= render 'survey_tab_pane', index: 0, next_tab: 1 do %>
      <!-- <h2 class="mb-5 main-text-color">필요한 칼로리를 구하기 위한<br>알고리즘</h2>-->

      <h4 class="main-text-color text-left">신체정보와 목표를 입력해주세요.</h4>
      <div class="row">
        <div class="col-6 row pb-2 mx-0">
          <%= label_tag "age", "나이  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= text_field_tag "age", "#{30 if Rails.env.development?}", class: "form-control col-6 text-right", required: true %>
        </div>
        <div class="col-6 row pb-2 mx-0">
          <%= label_tag "weight", "체중  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= number_field_tag "weight", "#{70 if Rails.env.development?}", class: "form-control col-6 text-right", required: true %>
          <div class="col-2 p-0 line-height-30 main-text-color">kg</div>
        </div>
        <div class="col-12 row pb-2 mx-0">
          <%= label_tag "target_weight", "목표 체중  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= number_field_tag "target_weight", "#{80 if Rails.env.development?}" , class: "form-control col-6 text-right", required: true %>
          <div class="col-2 p-0 line-height-30 main-text-color">kg</div>
        </div>
        <div class="col-12 row pb-2 mx-0">
          <%= label_tag "target_date", "목표 날짜  : ", class: "col-4 pl-0 text-left line-height-30 font-weight-bold" %>
          <%= text_field_tag "target_date", "#{'2020-12-31' if Rails.env.development?}" , class: "form-control col-8 text-right", readonly: true, required: true %>
        </div>

      </div>

      <h4 class="main-text-color text-left">당신의 활동량은 어떻게 되시나요?</h4>
      <% options = ["대부분 앉아있는다. ex) 사무직", "걷는걸 좋아하고 돌아다닐일이 많다.", "많이 활동 하는 생활을 한다. ex) 영업직", "매우 매우 활동적이다. ex) 영업직, 서비스직"]%>
      <%= select_tag "activity", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option", required: true %>

      <h4 class="main-text-color text-left">당신은 1회 운동할 때 평균 몇 분을 운동 하시나요?</h4>
      <div class="row mx-0 main-text-color">
        <%= number_field_tag "work_time",  "#{1.5 if Rails.env.development?}" ,class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">시간</span>
      </div>

      <h4 class="main-text-color text-left">당신은 그 운동을 주 몇 회 이상 하실 계획입니까?</h4>
      <div class="row mx-0 main-text-color">
        <%= number_field_tag "work_count", "#{3 if Rails.env.development?}" , class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>
        
    <% end %>

    <%= render 'survey_tab_pane', index: 1, prev_tab: 0, next_tab: 2 do %>
      <!-- <h2 class="mb-5 main-text-color">소비자가 먹고있는 칼로리를<br>구하기 위한 알고리즘 질문</h2>-->
      <h4 class="main-text-color mt-2 text-left">이번엔 정말로 마음 먹으셨습니까?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= radio_button_tag :dummy1, 'yes', true, class: "mr-2 ", style: "display:none;" %>
        <%= label_tag "dummy1_yes", '네', class: "main-text-color mr-3 font-weight-bold btn" %>
        <%= radio_button_tag :dummy1, 'no', false, class: "mr-2", style: "display:none;" %>
        <%= label_tag "dummy1_no", '아니오', class: "main-text-color font-weight-bold btn" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">식단관리를 통해 어떤 목표를 이루고 싶나요?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%# options = ["옷을 입었을 때 적당히 티가나는 마르고 탄탄한 몸", "나는 이번에 물놀이를 할거야! 누가봐도 몸짱! ", "많은 근육을 키우고 싶어!", "몸짱보단 더 나은 활력, 기능적인 증가"] %>
        <% options = [["벌크업", :bulk_up], ["다이어트", :slim]] %>
        <%= select_tag "purpose", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">당신의 의지력은 어떻게 되십니까?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = ["내가 마음을 먹었다면 무조건 이루어 내야한다.", "보통 만큼의 의지력을 소유하고 있다.", "난 의지력이 존재하긴 할까?..."] %>
        <%= select_tag "dummy3", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">한국인 평균 한 끼 식사 칼로리는 약 700 kal입니다 - 이런 식사를 당신은 하루에 몇 끼 정도 드시나요? </h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "kcal", "#{3 if Rails.env.development?}" , class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>

    <% end %>
    <%= render 'survey_tab_pane', index: 2, prev_tab: 1, next_tab: -1 do %>
      <h4 class="main-text-color mt-2 text-left">평소에 단백질을 많이 섭취하십니까?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = [["아니오", :low], ["네", :high]] %>
        <%= select_tag "protein", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">당신은 하루에 간식을 몇번 드시나요? (바닐라라떼, 케이크, 빵)</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "snack", "#{1 if Rails.env.development?}", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>
      
      <h4 class="main-text-color mt-2 text-left">당신은 일주일에 야식, 외식, 또는 술자리를 몇 번 가지시나요?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= number_field_tag "drink", "#{1 if Rails.env.development?}", class: "form-control col-10 text-right", required: true %> 
        <span class="line-height-30 pl-3 main-text-color">회</span>
      </div>

      <h4 class="main-text-color mt-2 text-left">당신은 일주일 동안 한 종류의 음식만 먹는다면 어떤걸 드실건가요?</h4>
      <div class="row pb-3 mx-0 main-text-color">
        <% options = ["고기 류", "빵, 밥, 면"] %>
        <%= select_tag "dummy4", options_for_select(options), class: "form-control mb-3 col-12 px-1 custom_option" %>
      </div>

      <h4 class="main-text-color mt-2 text-left">당신이 지금 떠오르는 제일 먹고 싶은 음식 한 가지를 써주세요 </h4>
      <div class="row pb-3 mx-0 main-text-color">
        <%= text_field_tag "dummy5", "", class: "form-control col-12" %> 
      </div>
    <% end %>

    <%= render 'survey_tab_pane', index: -1, prev_tab: 2 do %>
      <!-- <h2 class="mb-5 main-text-color">계산결과</h2>-->
      <div class="container text-white py-4">
      
        <h4 class="bg-custom-grey main-text-color py-2 line-height-25" style="margin-top:-15px;">계산 결과</h4>
        <div class="row mx-0 pt-3 main-text-color">
          <div class="col-12">
            <div class="border cal_result row">
              <div class="col-5">
                <div class="py-3">
                  <div class="calorie-title mb-2">현재 하루 섭취 칼로리</div>
                  <div class="d-flex justify-content-center">
                    <h4 class="mb-0" id="current-calorie-amount">0000</h4> &nbsp; <span class="secondary-text-color">Kcal</span>
                    <%= hidden_field_tag :current_calorie %>
                  </div>
                </div>
              </div>
              <div class="col-2 m-auto">
                <i class="fas fa-caret-right" style="font-size:30px;"></i>
              </div>
              <div class="col-5">
                <div class="py-3">
                  <div class="calorie-title mb-2">목표 하루 섭취 칼로리</div>
                  <div class="d-flex justify-content-center">
                    <h4 class="mb-0" id="target-calorie-amount">0000</h4> &nbsp; <span class="secondary-text-color">Kcal</span>
                    <%= hidden_field_tag :target_calorie %>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12">
            <h3 class="main-text-color mt-4 mb-5" id="difference"></h3>
            <div class="row" id="sub_items"></div>
          </div>
        </div>
      </div>
      <div class="mt-3 mb-5 col-12">
        <a class="btn btn-block btn-custom-grey nav-btn" id="tab-button-2" data-toggle="tab" href="#tab-2" role="tab" onclick="$('#top-progress-bar').width('75%')">이전</a>
      </div>
      <%= render 'users/sub_items_and_calorie_bar' %>
    <% end %>
  </div>
<% end %>

<script>
  var total_calorie_rate = ideal_carbo = ideal_protein = ideal_fat = 0;

  $(".nav-btn").click(function(){
    $(this).removeClass("active");
  });
  $("#target_date").datepicker({
                dateFormat: 'yy-mm-dd' //Input Display Format 변경
                ,showOtherMonths: true //빈 공간에 현재월의 앞뒤월의 날짜를 표시
                ,showMonthAfterYear:true //년도 먼저 나오고, 뒤에 월 표시
                ,changeYear: true //콤보박스에서 년 선택 가능
                ,changeMonth: true //콤보박스에서 월 선택 가능                
                ,buttonImageOnly: true //기본 버튼의 회색 부분을 없애고, 이미지만 보이게 함
                ,buttonText: "선택" //버튼에 마우스 갖다 댔을 때 표시되는 텍스트                
                ,yearSuffix: "년" //달력의 년도 부분 뒤에 붙는 텍스트
                ,monthNamesShort: ['1','2','3','4','5','6','7','8','9','10','11','12'] //달력의 월 부분 텍스트
                ,monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'] //달력의 월 부분 Tooltip 텍스트
                ,dayNamesMin: ['일','월','화','수','목','금','토'] //달력의 요일 부분 텍스트
                ,dayNames: ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'] //달력의 요일 부분 Tooltip 텍스트
                ,minDate: "+D" //최소 선택일자(-1D:하루전, -1M:한달전, -1Y:일년전)
                ,maxDate: "+10Y" //최대 선택일자(+1D:하루후, -1M:한달후, -1Y:일년후)                
            }); 

  $(".calculate-btn").click(function(){
    let weight = parseFloat($("#weight").val());
    let target_weight = parseFloat($("#target_weight").val());
    let target_date = $("#target_date").val();
    let difference = (target_weight - weight);
    let standard_kcal = (difference < 0) ?  7200 : 9000;
    target_date = new Date(target_date);
    let today = new Date();
    let diffTime = Math.abs(target_date - today);
    let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
    let purpose = $("#purpose").val();
    let work_time = parseFloat($("#work_time").val());
    let work_count = parseInt($("#work_count").val());
    let kcal = (parseInt($("#kcal").val()) * 700);
    let snack = (parseInt($("#snack").val()) * 200) / 7;
    let drink = (parseInt($("#drink").val()) * 700) / 7;
    
    let present_result = kcal + snack + drink
    let target_result = present_result + ((standard_kcal * difference) / diffDays) + ((work_count * work_time * 330) / 7);
    if (isNaN(present_result) || isNaN(target_result)){
      Swal.fire({
        title: "계산실패",
        button: false,
        text: "값을 모두 입력해주세요."
      });
      return false;
    }else {
      $("#current-calorie-amount").text(`${present_result.toFixed(2)}`);
      $("#target-calorie-amount").text(`${target_result.toFixed(2)}`);
      $("#current_calorie").val(`${present_result.toFixed(2)}`);
      $("#target_calorie").val(`${target_result.toFixed(2)}`);

      total_calorie_rate = target_result.toFixed(2);
      ideal_protein = Math.round(target_weight * 1.5)
      ideal_fat = Math.round(target_weight * 1.1)
      ideal_carbo = Math.round((total_calorie_rate - (ideal_protein * 4) - (ideal_fat * 9)) / 4)
      
      $("#current-calorie-bar").height(`${present_result.toFixed(2)/60}%`);
      $("#target-calorie-bar").height(`${target_result.toFixed(2)/60}%`);
//       $("#difference").text(`하루에 ${(target_result - present_result).toFixed(2)} Kcal 만큼 ${(difference < 0) ? '덜' : '더'} 드셔야 합니다.`);
      Rails.fire($('#recommend')[0], 'submit');
    }
  });
</script>